name: Setup WSL
description: Setup WSL2 environment with Docker support

runs:
  using: composite
  steps:
    - uses: vampire/setup-wsl@6a8db447be7ed35f2f499c02c6e60ff77ef11278 # v6.0.0
      with:
        distribution: Ubuntu-24.04
        use-cache: true
        set-as-default: true
        additional-packages: ca-certificates curl

    - name: setup docker CE
      shell: wsl-bash {0}
      run: |
        # Use docker's apt repo for newer versions that support modern Windows networking features
        # for better stability.
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc

        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli

        # We listen on TCP to easily access from Windows
        sudo sed -i 's|-H fd://|-H fd:// -H tcp://0.0.0.0:2375|' /lib/systemd/system/docker.service
        sudo systemctl daemon-reload
        sudo systemctl restart docker.service

        # This magic command allows WSL to run in the background forever
        sudo dbus-launch true

        export DOCKER_HOST=tcp://127.0.0.1:2375
        echo "Waiting for Docker Daemon..."
        for i in {1..30}; do
          if sudo docker info > /dev/null 2>&1; then
            echo "Docker Daemon is ACTIVE."
            exit 0
          fi
          echo "Waiting... ($i/30)"
          sleep 1
        done
        echo "Docker Daemon failed to start."
        exit 1

    - name: allow docker access from Windows
      shell: pwsh
      run: |
        echo "DOCKER_HOST=tcp://localhost:2375" >> $env:GITHUB_ENV

    - name: Verify Docker Bridge from Windows
      shell: pwsh
      run: docker version
